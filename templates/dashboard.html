{% extends "base.html" %}

{% block content %}
<header>
    <h1>Dashboard</h1>
    <p class="subtitle">Recent Stock Drops & AI Decisions</p>
</header>

<section>
    <div class="card" style="overflow-x: auto;">
        <table class="table table-striped table-hover"
            style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead class="thead-dark">
                <tr style="border-bottom: 1px solid #334155; color: #94a3b8;">
                    <th style="padding: 1rem;">Timestamp</th>
                    <th style="padding: 1rem;">Symbol</th>
                    <th style="padding: 1rem;">Company Name</th>
                    <th style="padding: 1rem;">Price</th>
                    <th style="padding: 1rem;">Drop %</th>
                    <th style="padding: 1rem;">Recommendation</th>
                    <th style="padding: 1rem;">Reasoning</th>
                    <th style="padding: 1rem;">Earnings</th>
                    <th style="padding: 1rem;">P/E</th>
                    <th style="padding: 1rem;">Market Cap</th>
                    <th style="padding: 1rem;">Sector</th>
                    <th style="padding: 1rem;">Region</th>
                </tr>
            </thead>
            <tbody>
                {% for dp in decision_points %}
                <tr style="border-bottom: 1px solid #1e293b;">
                    <td style="padding: 1rem;">{{ dp.timestamp }}</td>
                    <td style="padding: 1rem;"><a href="https://finance.yahoo.com/quote/{{ dp.symbol }}" target="_blank"
                            style="color: #60a5fa; text-decoration: none; font-weight: bold;">{{ dp.symbol }}</a></td>
                    <td style="padding: 1rem;">{{ dp.company_name or '-' }}</td>
                    <td style="padding: 1rem;">${{ "%.2f"|format(dp.price_at_decision) }}</td>
                    <td style="padding: 1rem; color: #f87171; font-weight: bold;">{{ "%.2f"|format(dp.drop_percent) }}%
                    </td>
                    <td style="padding: 1rem;">
                        {% if dp.recommendation == 'ANALYZING' %}
                        <span
                            style="background: #1e3a8a; color: #93c5fd; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">ANALYZING</span>
                        {% elif dp.recommendation == 'QUEUED' %}
                        <span
                            style="background: #374151; color: #9ca3af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">QUEUED</span>
                        {% else %}
                        {# Try to parse as float for scoring #}
                        {% set score = dp.recommendation|float(default=None) %}
                        {% if score is not none %}
                        {% if score >= 8.0 %}
                        <span
                            style="background: #052e16; color: #4ade80; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                            score }}/10</span>
                        {% elif score >= 6.0 %}
                        <span
                            style="background: #064e3b; color: #34d399; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                            score }}/10</span>
                        {% elif score >= 4.0 %}
                        <span
                            style="background: #451a03; color: #fbbf24; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                            score }}/10</span>
                        {% else %}
                        <span
                            style="background: #450a0a; color: #f87171; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                            score }}/10</span>
                        {% endif %}
                        {% else %}
                        {# Legacy Text Support #}
                        {% if dp.recommendation == 'STRONG BUY' %}
                        <span
                            style="background: #052e16; color: #4ade80; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">STRONG
                            BUY</span>
                        {% elif dp.recommendation == 'BUY' %}
                        <span
                            style="background: #064e3b; color: #34d399; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">BUY</span>
                        {% elif dp.recommendation == 'SELL' %}
                        <span
                            style="background: #450a0a; color: #f87171; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">SELL</span>
                        {% else %}
                        <span
                            style="background: #451a03; color: #fbbf24; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">{{
                            dp.recommendation }}</span>
                        {% endif %}
                        {% endif %}
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        <a href="/decision/{{ dp.id }}" target="_blank"
                            style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; border: 1px solid #475569; background: transparent; color: #94a3b8; text-decoration: none; font-size: 0.9rem;">
                            View
                        </a>
                    </td>
                    <td style="padding: 1rem;">
                        {% if dp.is_earnings_drop %}
                        <span title="{{ dp.earnings_date }}"
                            style="background: #7c3aed; color: #e8d5ff; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: bold;">EARNINGS</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">{{ "%.2f"|format(dp.pe_ratio) if dp.pe_ratio else '-' }}</td>
                    <td style="padding: 1rem;">
                        {% if dp.market_cap %}
                        {{ "%.2f"|format(dp.market_cap / 1000000000) }}B
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">{{ dp.sector or '-' }}</td>
                    <td style="padding: 1rem;">{{ dp.region or '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" style="padding: 2rem; text-align: center; color: #64748b;">No decisions recorded
                        yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}

{% block scripts %}
<!-- No scripts needed for static table -->
{% endblock %}